<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bet Distribution | Roulette Management Dashboard</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- ApexCharts -->
    <link href="https://cdn.jsdelivr.net/npm/apexcharts@3.35.0/dist/apexcharts.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="dashboard-styles.css">
    <style>
        .bet-distribution-container {
            background-color: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }
        
        .chart-container {
            min-height: 400px;
        }
        
        .bet-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .bet-info-item {
            background-color: var(--bg-element);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .bet-info-item.has-bets {
            border-left: 3px solid var(--color-success);
        }
        
        .bet-info-item.no-bets {
            border-left: 3px solid var(--color-danger);
            opacity: 0.7;
        }
        
        .number-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-weight: bold;
            margin-bottom: 8px;
            color: white;
        }
        
        .number-badge.red {
            background-color: #e74c3c;
        }
        
        .number-badge.black {
            background-color: #2c3e50;
        }
        
        .number-badge.green {
            background-color: #2ecc71;
        }
        
        .bet-count {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .payout-amount {
            font-weight: bold;
            color: var(--color-success);
            margin-top: 5px;
        }
        
        .number-details {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .legend-container {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        
        .no-bets-legend {
            background-color: #ccc;
        }
        
        .has-bets-legend {
            background-color: #2ecc71;
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .view-tab {
            padding: 8px 15px;
            background-color: var(--bg-element);
            border: none;
            border-radius: 4px;
            margin-right: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .view-tab.active {
            background-color: var(--color-primary);
            color: white;
        }
        
        .view-container {
            display: none;
        }
        
        .view-container.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .bet-info-grid {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            }
            
            .number-badge {
                width: 30px;
                height: 30px;
                font-size: 0.9rem;
            }
            
            .bet-count, .payout-amount {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">
                    <i class="fas fa-dice"></i>
                    <span>Roulette Manager</span>
                </div>
            </div>
            <div class="sidebar-menu">
                <div class="menu-item">
                    <a href="ultimate_dashboard.html">
                        <i class="fas fa-chart-line"></i>
                        <span>Dashboard</span>
                    </a>
                </div>
                <div class="menu-item">
                    <a href="draws_won.html">
                        <i class="fas fa-trophy"></i>
                        <span>Winning Draws</span>
                    </a>
                </div>
                <div class="menu-item">
                    <a href="draws_lost.html">
                        <i class="fas fa-times-circle"></i>
                        <span>Lost Draws</span>
                    </a>
                </div>
                <div class="menu-item">
                    <a href="draws_pending.html">
                        <i class="fas fa-clock"></i>
                        <span>Pending Cashouts</span>
                    </a>
                </div>
                <div class="menu-item">
                    <a href="draws_cashed.html">
                        <i class="fas fa-check-circle"></i>
                        <span>Cashed Out</span>
                    </a>
                </div>
                <div class="menu-item active">
                    <a href="bet_distribution.html">
                        <i class="fas fa-chart-bar"></i>
                        <span>Bet Distribution</span>
                    </a>
                </div>
                <div class="menu-item">
                    <a href="draw_control.html">
                        <i class="fas fa-sliders-h"></i>
                        <span>Draw Control</span>
                    </a>
                </div>
                <div class="menu-item">
                    <a href="draw_test.html">
                        <i class="fas fa-vial"></i>
                        <span>Test Draw</span>
                    </a>
                </div>
                <div class="menu-item">
                    <a href="#">
                        <i class="fas fa-users"></i>
                        <span>Players</span>
                    </a>
                </div>
                <div class="menu-item">
                    <a href="#">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </div>
            </div>
            <div class="sidebar-footer">
                &copy; 2023 Roulette Manager
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-header">
                <div class="header-title">
                    <h1>Bet Distribution</h1>
                </div>
                <div class="header-actions">
                    <button id="refreshButton" class="header-button">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                </div>
            </div>

            <div class="tab-container">
                <button class="view-tab active" data-view="chart">Chart View</button>
                <button class="view-tab" data-view="grid">Grid View</button>
            </div>

            <div class="bet-distribution-container">
                <div class="auto-refresh-status">
                    <i class="fas fa-circle-notch fa-spin"></i>
                    <span>Auto-refreshing data for upcoming draw every 15 seconds</span>
                </div>
                
                <div class="draw-info-header">
                    <h2>Upcoming Draw: <span id="upcomingDrawNumber">Loading...</span> (Current Draw)</h2>
                    <div class="legend-container">
                        <div class="legend-item">
                            <div class="legend-color has-bets-legend"></div>
                            <span>Has Bets</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color no-bets-legend"></div>
                            <span>No Bets</span>
                        </div>
                    </div>
                </div>
                
                <div class="view-container active" id="chartView">
                    <div id="chartContainer" class="chart-container">
                        <div class="loading-indicator">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Loading bet distribution data...</p>
                        </div>
                    </div>
                </div>
                
                <div class="view-container" id="gridView">
                    <div id="betInfoGrid" class="bet-info-grid">
                        <!-- Bet information for each number will be populated here -->
                        <div class="loading-indicator">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Loading bet distribution data...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bet-summary-container">
                <div class="bet-distribution-container">
                    <h3>Bet Type Distribution</h3>
                    <div id="betTypeChartContainer" class="chart-container">
                        <div class="loading-indicator">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Loading bet type distribution...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading data...</div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.35.0/dist/apexcharts.min.js"></script>
    <script>
        // Global variables
        let loadingOverlay;
        let refreshInterval;
        let betDistributionChart;
        let betTypeChart;
        let currentData = null;
        let upcomingDrawNumber = null;
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Bet distribution page loaded');
            
            // Cache DOM elements
            loadingOverlay = document.getElementById('loadingOverlay');
            
            // Set up refresh button
            document.getElementById('refreshButton').addEventListener('click', function() {
                console.log('Refresh button clicked');
                fetchBetDistribution();
            });
            
            // Set up view tabs
            const viewTabs = document.querySelectorAll('.view-tab');
            viewTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const viewName = this.getAttribute('data-view');
                    
                    // Update active tab
                    viewTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show corresponding view
                    document.querySelectorAll('.view-container').forEach(view => {
                        view.classList.remove('active');
                    });
                    document.getElementById(viewName + 'View').classList.add('active');
                    
                    // Redraw chart if needed
                    if (viewName === 'chart' && betDistributionChart) {
                        setTimeout(() => {
                            betDistributionChart.render();
                        }, 10);
                    }
                });
            });
            
            // Initial data fetch
            fetchBetDistribution();
            
            // Set up auto refresh - every 15 seconds
            refreshInterval = setInterval(fetchBetDistribution, 15000);
        });
        
        // Function to fetch bet distribution data
        async function fetchBetDistribution() {
            showLoading(true);
            
            try {
                // Fetch the upcoming draw's bet distribution
                const response = await fetch('../php/get_bet_distribution.php?upcoming=1');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Fetched bet distribution data:', data);
                
                if (data.status === 'success') {
                    currentData = data;
                    upcomingDrawNumber = data.draw_number;
                    
                    // Update the UI
                    updateBetDistributionUI(data);
                    updateLastUpdated();
                } else {
                    showError(data.message || 'Failed to fetch bet distribution data');
                }
            } catch (error) {
                console.error('Error fetching bet distribution:', error);
                showError('Failed to fetch bet distribution data. Please try again later.');
            } finally {
                showLoading(false);
            }
        }
        
        // Function to update the bet distribution UI
        function updateBetDistributionUI(data) {
            // Update upcoming draw number
            document.getElementById('upcomingDrawNumber').textContent = `#${data.draw_number}`;
            
            // Update chart view
            updateBetDistributionChart(data);
            
            // Update grid view
            updateBetDistributionGrid(data);
            
            // Update bet type distribution chart
            updateBetTypeDistributionChart(data);
        }
        
        // Function to update the bet distribution chart
        function updateBetDistributionChart(data) {
            const chartContainer = document.getElementById('chartContainer');
            chartContainer.innerHTML = ''; // Clear previous chart
            
            const seriesData = [];
            const colors = [];
            
            // Prepare data for chart
            for (let i = 0; i <= 36; i++) {
                const numberData = data.numbers[i] || { bet_count: 0, total_payout: 0 };
                seriesData.push({
                    x: i.toString(),
                    y: numberData.bet_count || 0,
                    payout: formatCurrency(numberData.total_payout || 0),
                    color: getNumberColor(i)
                });
                
                // Set bar color based on whether there are bets
                if (numberData.bet_count > 0) {
                    colors.push('#2ecc71'); // Green for numbers with bets
                } else {
                    colors.push('#cccccc'); // Gray for numbers without bets
                }
            }
            
            const options = {
                series: [{
                    name: 'Number of Bets',
                    data: seriesData
                }],
                chart: {
                    type: 'bar',
                    height: 400,
                    toolbar: {
                        show: true,
                        tools: {
                            download: true,
                            selection: false,
                            zoom: false,
                            zoomin: false,
                            zoomout: false,
                            pan: false,
                            reset: false
                        }
                    }
                },
                plotOptions: {
                    bar: {
                        distributed: true,
                        borderRadius: 4,
                        columnWidth: '80%',
                        dataLabels: {
                            position: 'top'
                        }
                    }
                },
                colors: colors,
                dataLabels: {
                    enabled: true,
                    formatter: function(val) {
                        return val > 0 ? val : '';
                    },
                    offsetY: -20,
                    style: {
                        fontSize: '12px',
                        colors: ["#304758"]
                    }
                },
                xaxis: {
                    categories: Array.from({ length: 37 }, (_, i) => i.toString()),
                    labels: {
                        style: {
                            colors: Array(37).fill('#666')
                        }
                    },
                    title: {
                        text: 'Roulette Numbers'
                    }
                },
                yaxis: {
                    title: {
                        text: 'Number of Bets'
                    }
                },
                tooltip: {
                    y: {
                        formatter: function(val, { seriesIndex, dataPointIndex, w }) {
                            const dataPoint = w.config.series[seriesIndex].data[dataPointIndex];
                            return `<div>
                                <div>Number of Bets: ${val}</div>
                                <div>Potential Payout: ${dataPoint.payout}</div>
                            </div>`;
                        }
                    },
                    custom: function({ series, seriesIndex, dataPointIndex, w }) {
                        const dataPoint = w.config.series[seriesIndex].data[dataPointIndex];
                        return `<div class="apexcharts-tooltip-box">
                            <div style="background-color: ${dataPoint.color}; width: 20px; height: 20px; border-radius: 50%; margin: 5px auto;"></div>
                            <div style="text-align: center; font-weight: bold; margin-bottom: 5px;">Number ${dataPoint.x}</div>
                            <div>Number of Bets: ${dataPoint.y}</div>
                            <div>Potential Payout: ${dataPoint.payout}</div>
                        </div>`;
                    }
                },
                title: {
                    text: 'Bet Distribution by Number',
                    align: 'center',
                    margin: 15,
                    style: {
                        fontSize: '16px',
                        fontWeight: 'bold'
                    }
                }
            };
            
            betDistributionChart = new ApexCharts(chartContainer, options);
            betDistributionChart.render();
        }
        
        // Function to update the bet distribution grid
        function updateBetDistributionGrid(data) {
            const gridContainer = document.getElementById('betInfoGrid');
            gridContainer.innerHTML = ''; // Clear previous content
            
            // Create a grid item for each number
            for (let i = 0; i <= 36; i++) {
                const numberData = data.numbers[i] || { bet_count: 0, total_payout: 0 };
                const hasBets = numberData.bet_count > 0;
                
                const gridItem = document.createElement('div');
                gridItem.className = `bet-info-item ${hasBets ? 'has-bets' : 'no-bets'}`;
                
                gridItem.innerHTML = `
                    <div class="number-details">
                        <div class="number-badge ${getNumberColor(i)}">${i}</div>
                        <div class="bet-count">${hasBets ? numberData.bet_count + ' bets' : 'No bets'}</div>
                        <div class="payout-amount">${formatCurrency(numberData.total_payout || 0)}</div>
                    </div>
                `;
                
                gridContainer.appendChild(gridItem);
            }
        }
        
        // Function to update the bet type distribution chart
        function updateBetTypeDistributionChart(data) {
            const chartContainer = document.getElementById('betTypeChartContainer');
            chartContainer.innerHTML = ''; // Clear previous chart
            
            // Check if we have bet types data
            if (!data.bet_types || Object.keys(data.bet_types).length === 0) {
                chartContainer.innerHTML = `
                    <div class="no-data-message">
                        <i class="fas fa-info-circle"></i>
                        <p>No bet type data available for the upcoming draw.</p>
                    </div>
                `;
                return;
            }
            
            // Prepare data for chart
            const betTypes = Object.keys(data.bet_types);
            const betCounts = betTypes.map(type => data.bet_types[type].bet_count || 0);
            const payouts = betTypes.map(type => data.bet_types[type].total_payout || 0);
            
            const options = {
                series: [{
                    name: 'Number of Bets',
                    data: betCounts
                }, {
                    name: 'Potential Payout',
                    data: payouts
                }],
                chart: {
                    type: 'bar',
                    height: 350,
                    stacked: false,
                    toolbar: {
                        show: true
                    }
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '55%',
                        borderRadius: 4,
                    },
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    show: true,
                    width: 2,
                    colors: ['transparent']
                },
                xaxis: {
                    categories: betTypes.map(formatBetTypeLabel),
                    labels: {
                        style: {
                            fontSize: '12px'
                        },
                        rotate: -45,
                        rotateAlways: true
                    }
                },
                yaxis: [
                    {
                        title: {
                            text: 'Number of Bets'
                        }
                    },
                    {
                        opposite: true,
                        title: {
                            text: 'Potential Payout ($)'
                        }
                    }
                ],
                fill: {
                    opacity: 1
                },
                tooltip: {
                    y: {
                        formatter: function(val, { seriesIndex }) {
                            if (seriesIndex === 0) {
                                return val + ' bets';
                            } else {
                                return formatCurrency(val);
                            }
                        }
                    }
                },
                title: {
                    text: 'Bet Type Distribution',
                    align: 'center',
                    margin: 15,
                    style: {
                        fontSize: '16px',
                        fontWeight: 'bold'
                    }
                },
                colors: ['#3498db', '#2ecc71']
            };
            
            betTypeChart = new ApexCharts(chartContainer, options);
            betTypeChart.render();
        }
        
        // Function to format bet type labels
        function formatBetTypeLabel(betType) {
            const typeMap = {
                'straight': 'Straight Up',
                'split': 'Split',
                'street': 'Street',
                'corner': 'Corner',
                'line': 'Line',
                'dozen': 'Dozen',
                'column': 'Column',
                'red': 'Red',
                'black': 'Black',
                'even': 'Even',
                'odd': 'Odd',
                'low': 'Low (1-18)',
                'high': 'High (19-36)'
            };
            
            return typeMap[betType] || capitalize(betType);
        }
        
        // Function to get number color
        function getNumberColor(number) {
            if (number === 0) {
                return 'green';
            } else if ([1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36].includes(number)) {
                return 'red';
            } else {
                return 'black';
            }
        }
        
        // Function to capitalize first letter
        function capitalize(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        // Function to format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(amount);
        }
        
        // Function to show/hide loading overlay
        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }
        
        // Function to update last updated timestamp
        function updateLastUpdated() {
            const lastUpdated = new Date();
            const elements = document.querySelectorAll('.auto-refresh-status span');
            elements.forEach(el => {
                el.innerHTML = `Auto-refreshing data for upcoming draw every 15 seconds (Last updated: ${lastUpdated.toLocaleTimeString()})`;
            });
        }
        
        // Function to show error message
        function showError(message) {
            const chartContainer = document.getElementById('chartContainer');
            const gridContainer = document.getElementById('betInfoGrid');
            
            // Show error in chart view
            chartContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>${message}</p>
                    <button class="header-button" onclick="fetchBetDistribution()">
                        <i class="fas fa-sync-alt"></i> Try Again
                    </button>
                </div>
            `;
            
            // Show error in grid view
            gridContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>${message}</p>
                </div>
            `;
        }
    </script>
</body>
</html> 