<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Master-Client Sync Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 10px;
            border: 2px solid #FFD700;
        }
        .test-section {
            background: #2a2a2a;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #FFD700;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .display-frame {
            border: 2px solid #FFD700;
            border-radius: 10px;
            overflow: hidden;
            background: white;
        }
        .display-frame iframe {
            width: 100%;
            height: 400px;
            border: none;
        }
        .display-label {
            background: #FFD700;
            color: black;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }
        .status-panel {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }
        .status-good { border-left: 5px solid #28a745; }
        .status-warning { border-left: 5px solid #ffc107; }
        .status-error { border-left: 5px solid #dc3545; }
        .test-button {
            background: #FFD700;
            color: black;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        .test-button:hover {
            background: #e6c200;
        }
        .console-output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .timer-display {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            background: #000;
            border-radius: 5px;
            margin: 10px 0;
        }
        .sync-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .sync-good { background: #28a745; }
        .sync-warning { background: #ffc107; }
        .sync-error { background: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé∞ Master-Client Synchronization Debug Test</h1>
            <p>Real-time testing and debugging of timer sync and roulette board visibility</p>
            <div id="overall-status" class="status-panel status-warning">
                <span class="sync-indicator sync-warning"></span>
                <strong>Status:</strong> Initializing tests...
            </div>
        </div>

        <div class="test-section">
            <h2>üîç Live Display Monitoring</h2>
            <div class="test-grid">
                <div class="display-frame">
                    <div class="display-label">üëë MASTER (index.html)</div>
                    <iframe id="master-frame" src="index.html"></iframe>
                </div>
                <div class="display-frame">
                    <div class="display-label">üì∫ CLIENT 1 (shop1.html)</div>
                    <iframe id="client1-frame" src="shop1.html"></iframe>
                </div>
                <div class="display-frame">
                    <div class="display-label">üì∫ CLIENT 2 (shop2.html)</div>
                    <iframe id="client2-frame" src="shop2.html"></iframe>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>‚è±Ô∏è Timer Synchronization Test</h2>
            <div class="timer-display" id="timer-status">
                Master: --:-- | Client 1: --:-- | Client 2: --:--
            </div>
            <div id="timer-sync-status" class="status-panel status-warning">
                <span class="sync-indicator sync-warning"></span>
                Monitoring timer synchronization...
            </div>
            <button class="test-button" onclick="testTimerSync()">üîÑ Test Timer Sync</button>
            <button class="test-button" onclick="forceTimerUpdate()">‚ö° Force Timer Update</button>
        </div>

        <div class="test-section">
            <h2>üé≤ Roulette Board Visibility Test</h2>
            <div id="board-visibility-status" class="status-panel status-warning">
                <span class="sync-indicator sync-warning"></span>
                Checking roulette board visibility...
            </div>
            <button class="test-button" onclick="testBoardVisibility()">üëÅÔ∏è Test Board Visibility</button>
            <button class="test-button" onclick="toggleBoardVisibility()">üîÑ Toggle Board Visibility</button>
        </div>

        <div class="test-section">
            <h2>üì° BroadcastChannel Communication Test</h2>
            <div id="broadcast-status" class="status-panel status-warning">
                <span class="sync-indicator sync-warning"></span>
                Testing BroadcastChannel communication...
            </div>
            <button class="test-button" onclick="testBroadcastChannel()">üì° Test Broadcast</button>
            <button class="test-button" onclick="sendTestMessage()">üì§ Send Test Message</button>
        </div>

        <div class="test-section">
            <h2>üñ•Ô∏è Console Output</h2>
            <div class="console-output" id="console-output">
                Initializing debug console...<br>
            </div>
            <button class="test-button" onclick="clearConsole()">üóëÔ∏è Clear Console</button>
            <button class="test-button" onclick="exportLogs()">üíæ Export Logs</button>
        </div>
    </div>

    <script>
        // Debug console
        const consoleOutput = document.getElementById('console-output');
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        function logToDebugConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'warn' ? '#ffd93d' : '#00ff00';
            consoleOutput.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span><br>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            logToDebugConsole(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            logToDebugConsole(args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            logToDebugConsole(args.join(' '), 'warn');
        };

        // Test functions
        function testTimerSync() {
            console.log('üîÑ Starting timer synchronization test...');
            
            try {
                const masterFrame = document.getElementById('master-frame');
                const client1Frame = document.getElementById('client1-frame');
                const client2Frame = document.getElementById('client2-frame');

                // Check if frames are loaded
                if (!masterFrame.contentWindow || !client1Frame.contentWindow || !client2Frame.contentWindow) {
                    console.error('‚ùå One or more frames not loaded');
                    return;
                }

                // Get timer values from each frame
                setTimeout(() => {
                    try {
                        const masterTimer = masterFrame.contentDocument?.getElementById('countdown-timer')?.textContent || '--:--';
                        const client1Timer = client1Frame.contentDocument?.getElementById('countdown-timer')?.textContent || '--:--';
                        const client2Timer = client2Frame.contentDocument?.getElementById('countdown-timer')?.textContent || '--:--';

                        document.getElementById('timer-status').textContent = 
                            `Master: ${masterTimer} | Client 1: ${client1Timer} | Client 2: ${client2Timer}`;

                        // Check synchronization
                        if (masterTimer === client1Timer && masterTimer === client2Timer && masterTimer !== '--:--') {
                            updateStatus('timer-sync-status', 'good', '‚úÖ Timers are synchronized!');
                            console.log('‚úÖ Timer synchronization test PASSED');
                        } else {
                            updateStatus('timer-sync-status', 'error', '‚ùå Timers are NOT synchronized!');
                            console.error('‚ùå Timer synchronization test FAILED');
                            console.error(`Master: ${masterTimer}, Client1: ${client1Timer}, Client2: ${client2Timer}`);
                        }
                    } catch (error) {
                        console.error('‚ùå Error accessing frame content:', error);
                        updateStatus('timer-sync-status', 'error', '‚ùå Cannot access frame content (CORS?)');
                    }
                }, 1000);

            } catch (error) {
                console.error('‚ùå Timer sync test error:', error);
                updateStatus('timer-sync-status', 'error', '‚ùå Timer sync test failed');
            }
        }

        function testBoardVisibility() {
            console.log('üëÅÔ∏è Testing roulette board visibility...');
            
            try {
                const frames = ['master-frame', 'client1-frame', 'client2-frame'];
                let visibilityResults = [];

                frames.forEach((frameId, index) => {
                    const frame = document.getElementById(frameId);
                    if (frame.contentDocument) {
                        const bettingArea = frame.contentDocument.querySelector('.betting-area');
                        const isVisible = bettingArea && 
                            getComputedStyle(bettingArea).display !== 'none' &&
                            getComputedStyle(bettingArea).visibility !== 'hidden' &&
                            bettingArea.offsetWidth > 0 && 
                            bettingArea.offsetHeight > 0;
                        
                        visibilityResults.push({
                            name: frameId.replace('-frame', ''),
                            visible: isVisible,
                            width: bettingArea?.offsetWidth || 0,
                            height: bettingArea?.offsetHeight || 0
                        });
                    }
                });

                console.log('üìä Board visibility results:', visibilityResults);
                
                const allVisible = visibilityResults.every(result => result.visible);
                if (allVisible) {
                    updateStatus('board-visibility-status', 'good', '‚úÖ Roulette board visible on all displays');
                } else {
                    updateStatus('board-visibility-status', 'error', '‚ùå Roulette board not visible on some displays');
                }

            } catch (error) {
                console.error('‚ùå Board visibility test error:', error);
                updateStatus('board-visibility-status', 'error', '‚ùå Board visibility test failed');
            }
        }

        function testBroadcastChannel() {
            console.log('üì° Testing BroadcastChannel communication...');
            
            try {
                const testChannel = new BroadcastChannel('roulette-sync-channel');
                let messageReceived = false;

                testChannel.onmessage = function(event) {
                    messageReceived = true;
                    console.log('üì® Received broadcast message:', event.data);
                    updateStatus('broadcast-status', 'good', '‚úÖ BroadcastChannel working');
                    testChannel.close();
                };

                // Send test message
                testChannel.postMessage({
                    type: 'debug_test',
                    timestamp: Date.now(),
                    message: 'Debug test message'
                });

                // Check if message was received
                setTimeout(() => {
                    if (!messageReceived) {
                        updateStatus('broadcast-status', 'error', '‚ùå BroadcastChannel not working');
                        console.error('‚ùå BroadcastChannel test failed - no message received');
                    }
                    testChannel.close();
                }, 2000);

            } catch (error) {
                console.error('‚ùå BroadcastChannel test error:', error);
                updateStatus('broadcast-status', 'error', '‚ùå BroadcastChannel not supported');
            }
        }

        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.className = `status-panel status-${status}`;
            
            const indicator = element.querySelector('.sync-indicator');
            if (indicator) {
                indicator.className = `sync-indicator sync-${status}`;
            }
            
            element.innerHTML = `<span class="sync-indicator sync-${status}"></span>${message}`;
        }

        function forceTimerUpdate() {
            console.log('‚ö° Forcing timer update...');
            // This would trigger a manual timer sync
        }

        function toggleBoardVisibility() {
            console.log('üîÑ Toggling board visibility...');
            // This would toggle the roulette board visibility
        }

        function sendTestMessage() {
            console.log('üì§ Sending test message...');
            testBroadcastChannel();
        }

        function clearConsole() {
            consoleOutput.innerHTML = 'Console cleared.<br>';
        }

        function exportLogs() {
            const logs = consoleOutput.textContent;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sync-debug-logs-${new Date().toISOString()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Auto-run tests on load
        window.addEventListener('load', function() {
            console.log('üé∞ Debug test page loaded');
            
            setTimeout(() => {
                testBroadcastChannel();
                testTimerSync();
                testBoardVisibility();
            }, 3000);

            // Auto-refresh tests every 10 seconds
            setInterval(() => {
                testTimerSync();
            }, 10000);
        });
    </script>
</body>
</html>
