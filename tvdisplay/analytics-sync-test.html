<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Analytics Synchronization Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 10px;
            border: 2px solid #FFD700;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .display-card {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #FFD700;
        }
        .display-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            color: #FFD700;
        }
        .iframe-container {
            width: 100%;
            height: 400px;
            border: 2px solid #555;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            transform: scale(0.7);
            transform-origin: 0 0;
            width: 142.86%;
            height: 142.86%;
        }
        .analytics-status {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        .status-metric {
            background: #444;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .status-metric .label {
            font-size: 12px;
            color: #ccc;
        }
        .status-metric .value {
            font-size: 16px;
            font-weight: bold;
            color: #FFD700;
        }
        .status-panel {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .status-good { border-left: 5px solid #28a745; }
        .status-warning { border-left: 5px solid #ffc107; }
        .status-error { border-left: 5px solid #dc3545; }
        .test-button {
            background: #FFD700;
            color: black;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            width: 100%;
        }
        .test-button:hover {
            background: #e6c200;
        }
        .control-panel {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #FFD700;
            margin: 20px 0;
        }
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .analytics-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .indicator-visible { background: #28a745; }
        .indicator-hidden { background: #6c757d; }
        .indicator-synced { background: #17a2b8; }
        .indicator-out-of-sync { background: #dc3545; }
        .console-output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            max-height: 250px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Analytics Synchronization Test</h1>
            <p>Real-time testing of analytics panel visibility and data synchronization across all displays</p>
            <div id="overall-status" class="status-panel status-warning">
                <strong>Status:</strong> Initializing analytics sync test...
            </div>
        </div>

        <div class="control-panel">
            <h2>üéÆ Analytics Test Controls</h2>
            <div class="control-grid">
                <button class="test-button" onclick="testPanelSync()">üìä Test Panel Visibility Sync</button>
                <button class="test-button" onclick="testDataSync()">üìà Test Data Sync</button>
                <button class="test-button" onclick="testFullSync()">üîÑ Test Full Analytics Sync</button>
                <button class="test-button" onclick="simulateAnalyticsUpdate()">üìä Simulate Analytics Update</button>
                <button class="test-button" onclick="refreshAllDisplays()">üîÑ Refresh All Displays</button>
                <button class="test-button" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
            </div>
        </div>

        <div class="test-grid">
            <!-- Master Display -->
            <div class="display-card">
                <div class="display-title">üëë MASTER DISPLAY</div>
                <div class="iframe-container">
                    <iframe id="master-frame" src="index.html"></iframe>
                </div>
                <div class="analytics-status">
                    <div class="status-metric">
                        <div class="label">Left Panel</div>
                        <div class="value" id="master-left">
                            <span class="analytics-indicator indicator-hidden"></span>Hidden
                        </div>
                    </div>
                    <div class="status-metric">
                        <div class="label">Right Panel</div>
                        <div class="value" id="master-right">
                            <span class="analytics-indicator indicator-hidden"></span>Hidden
                        </div>
                    </div>
                    <div class="status-metric">
                        <div class="label">Footer Panel</div>
                        <div class="value" id="master-footer">
                            <span class="analytics-indicator indicator-hidden"></span>Hidden
                        </div>
                    </div>
                    <div class="status-metric">
                        <div class="label">Data Updates</div>
                        <div class="value" id="master-updates">0</div>
                    </div>
                </div>
                <div class="status-panel" id="master-status">Master analytics status...</div>
                <button class="test-button" onclick="refreshMaster()">üîÑ Refresh Master</button>
            </div>

            <!-- Client 1 Display -->
            <div class="display-card">
                <div class="display-title">üì∫ CLIENT 1 (Shop 1)</div>
                <div class="iframe-container">
                    <iframe id="client1-frame" src="shop1.html"></iframe>
                </div>
                <div class="analytics-status">
                    <div class="status-metric">
                        <div class="label">Left Panel</div>
                        <div class="value" id="client1-left">
                            <span class="analytics-indicator indicator-hidden"></span>Hidden
                        </div>
                    </div>
                    <div class="status-metric">
                        <div class="label">Right Panel</div>
                        <div class="value" id="client1-right">
                            <span class="analytics-indicator indicator-hidden"></span>Hidden
                        </div>
                    </div>
                    <div class="status-metric">
                        <div class="label">Sync Status</div>
                        <div class="value" id="client1-sync">
                            <span class="analytics-indicator indicator-synced"></span>Synced
                        </div>
                    </div>
                    <div class="status-metric">
                        <div class="label">Last Sync</div>
                        <div class="value" id="client1-update">--:--</div>
                    </div>
                </div>
                <div class="status-panel" id="client1-status">Client 1 analytics status...</div>
                <button class="test-button" onclick="refreshClient1()">üîÑ Refresh Client 1</button>
            </div>

            <!-- Client 2 Display -->
            <div class="display-card">
                <div class="display-title">üì∫ CLIENT 2 (Shop 2)</div>
                <div class="iframe-container">
                    <iframe id="client2-frame" src="shop2.html"></iframe>
                </div>
                <div class="analytics-status">
                    <div class="status-metric">
                        <div class="label">Left Panel</div>
                        <div class="value" id="client2-left">
                            <span class="analytics-indicator indicator-hidden"></span>Hidden
                        </div>
                    </div>
                    <div class="status-metric">
                        <div class="label">Right Panel</div>
                        <div class="value" id="client2-right">
                            <span class="analytics-indicator indicator-hidden"></span>Hidden
                        </div>
                    </div>
                    <div class="status-metric">
                        <div class="label">Sync Status</div>
                        <div class="value" id="client2-sync">
                            <span class="analytics-indicator indicator-synced"></span>Synced
                        </div>
                    </div>
                    <div class="status-metric">
                        <div class="label">Last Sync</div>
                        <div class="value" id="client2-update">--:--</div>
                    </div>
                </div>
                <div class="status-panel" id="client2-status">Client 2 analytics status...</div>
                <button class="test-button" onclick="refreshClient2()">üîÑ Refresh Client 2</button>
            </div>
        </div>

        <div class="control-panel">
            <h2>üìä Synchronization Analysis</h2>
            <div id="sync-analysis" class="status-panel status-warning">
                Waiting for analytics synchronization data...
            </div>
        </div>

        <div class="control-panel">
            <h2>üñ•Ô∏è Console Output</h2>
            <div class="console-output" id="console-output">
                Analytics sync test initializing...<br>
            </div>
        </div>
    </div>

    <script>
        let testInterval;
        let analyticsData = {
            master: { left: false, right: false, footer: false, updates: 0 },
            client1: { left: false, right: false, sync: 'synced', lastUpdate: null },
            client2: { left: false, right: false, sync: 'synced', lastUpdate: null }
        };

        // Debug console
        const consoleOutput = document.getElementById('console-output');
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'warn' ? '#ffd93d' : '#00ff00';
            consoleOutput.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span><br>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        function getAnalyticsState(frameId) {
            try {
                const frame = document.getElementById(frameId);
                if (frame && frame.contentDocument) {
                    const leftSidebar = frame.contentDocument.querySelector('.analytics-left-sidebar');
                    const rightSidebar = frame.contentDocument.querySelector('.analytics-right-sidebar');
                    const footerBar = frame.contentDocument.querySelector('.analytics-footer-bar');
                    
                    const leftVisible = leftSidebar && (leftSidebar.classList.contains('visible') || leftSidebar.style.display !== 'none');
                    const rightVisible = rightSidebar && (rightSidebar.classList.contains('visible') || rightSidebar.style.display !== 'none');
                    const footerVisible = footerBar && (footerBar.classList.contains('visible') || footerBar.style.display !== 'none');
                    
                    return {
                        leftVisible: leftVisible,
                        rightVisible: rightVisible,
                        footerVisible: footerVisible,
                        anyVisible: leftVisible || rightVisible || footerVisible
                    };
                }
            } catch (error) {
                log(`Cannot access ${frameId} analytics: ${error.message}`, 'warn');
            }
            return null;
        }

        function updateAnalyticsMetrics() {
            const masterState = getAnalyticsState('master-frame');
            const client1State = getAnalyticsState('client1-frame');
            const client2State = getAnalyticsState('client2-frame');

            if (masterState) {
                updateDisplayMetric('master-left', masterState.leftVisible);
                updateDisplayMetric('master-right', masterState.rightVisible);
                updateDisplayMetric('master-footer', masterState.footerVisible);
                analyticsData.master = { 
                    left: masterState.leftVisible, 
                    right: masterState.rightVisible, 
                    footer: masterState.footerVisible,
                    updates: analyticsData.master.updates 
                };
            }

            if (client1State) {
                updateDisplayMetric('client1-left', client1State.leftVisible);
                updateDisplayMetric('client1-right', client1State.rightVisible);
                const syncStatus = (masterState && 
                    client1State.leftVisible === masterState.leftVisible && 
                    client1State.rightVisible === masterState.rightVisible) ? 'synced' : 'out-of-sync';
                updateSyncStatus('client1-sync', syncStatus);
                document.getElementById('client1-update').textContent = new Date().toLocaleTimeString();
                analyticsData.client1 = { 
                    left: client1State.leftVisible, 
                    right: client1State.rightVisible, 
                    sync: syncStatus, 
                    lastUpdate: Date.now() 
                };
            }

            if (client2State) {
                updateDisplayMetric('client2-left', client2State.leftVisible);
                updateDisplayMetric('client2-right', client2State.rightVisible);
                const syncStatus = (masterState && 
                    client2State.leftVisible === masterState.leftVisible && 
                    client2State.rightVisible === masterState.rightVisible) ? 'synced' : 'out-of-sync';
                updateSyncStatus('client2-sync', syncStatus);
                document.getElementById('client2-update').textContent = new Date().toLocaleTimeString();
                analyticsData.client2 = { 
                    left: client2State.leftVisible, 
                    right: client2State.rightVisible, 
                    sync: syncStatus, 
                    lastUpdate: Date.now() 
                };
            }

            updateSyncAnalysis();
        }

        function updateDisplayMetric(elementId, isVisible) {
            const element = document.getElementById(elementId);
            if (element) {
                const indicator = element.querySelector('.analytics-indicator');
                if (isVisible) {
                    indicator.className = 'analytics-indicator indicator-visible';
                    element.innerHTML = element.innerHTML.replace(/Hidden|Visible/, 'Visible');
                } else {
                    indicator.className = 'analytics-indicator indicator-hidden';
                    element.innerHTML = element.innerHTML.replace(/Hidden|Visible/, 'Hidden');
                }
            }
        }

        function updateSyncStatus(elementId, status) {
            const element = document.getElementById(elementId);
            if (element) {
                const indicator = element.querySelector('.analytics-indicator');
                if (status === 'synced') {
                    indicator.className = 'analytics-indicator indicator-synced';
                    element.innerHTML = element.innerHTML.replace(/Synced|Out of Sync/, 'Synced');
                } else {
                    indicator.className = 'analytics-indicator indicator-out-of-sync';
                    element.innerHTML = element.innerHTML.replace(/Synced|Out of Sync/, 'Out of Sync');
                }
            }
        }

        function updateSyncAnalysis() {
            const analysis = document.getElementById('sync-analysis');
            const overallStatus = document.getElementById('overall-status');
            
            let analysisText = `Last Update: ${new Date().toLocaleTimeString()}\n\n`;
            analysisText += `Master: Left=${analyticsData.master.left} | Right=${analyticsData.master.right} | Footer=${analyticsData.master.footer}\n`;
            analysisText += `Client 1: Left=${analyticsData.client1.left} | Right=${analyticsData.client1.right} | Sync=${analyticsData.client1.sync}\n`;
            analysisText += `Client 2: Left=${analyticsData.client2.left} | Right=${analyticsData.client2.right} | Sync=${analyticsData.client2.sync}\n\n`;
            
            const client1Synced = analyticsData.client1.sync === 'synced';
            const client2Synced = analyticsData.client2.sync === 'synced';
            
            if (client1Synced && client2Synced) {
                analysisText += '‚úÖ PERFECT ANALYTICS SYNCHRONIZATION\n';
                overallStatus.className = 'status-panel status-good';
                overallStatus.innerHTML = '<strong>Status:</strong> ‚úÖ Perfect Analytics Synchronization';
            } else if (client1Synced || client2Synced) {
                analysisText += '‚ö†Ô∏è PARTIAL ANALYTICS SYNCHRONIZATION\n';
                overallStatus.className = 'status-panel status-warning';
                overallStatus.innerHTML = '<strong>Status:</strong> ‚ö†Ô∏è Partial Analytics Synchronization';
            } else {
                analysisText += '‚ùå ANALYTICS SYNCHRONIZATION FAILED\n';
                overallStatus.className = 'status-panel status-error';
                overallStatus.innerHTML = '<strong>Status:</strong> ‚ùå Analytics Synchronization Failed';
            }
            
            analysis.textContent = analysisText;
        }

        // Test functions
        function testPanelSync() {
            log('üìä Testing analytics panel visibility synchronization...');
            updateAnalyticsMetrics();
        }

        function testDataSync() {
            log('üìà Testing analytics data synchronization...');
            updateAnalyticsMetrics();
        }

        function testFullSync() {
            log('üîÑ Testing full analytics synchronization...');
            updateAnalyticsMetrics();
        }

        function simulateAnalyticsUpdate() {
            log('üìä Simulating analytics update...');
            analyticsData.master.updates++;
            document.getElementById('master-updates').textContent = analyticsData.master.updates;
            updateAnalyticsMetrics();
        }

        function refreshMaster() {
            document.getElementById('master-frame').src = 'index.html?' + Date.now();
            log('üîÑ Master display refreshed');
        }

        function refreshClient1() {
            document.getElementById('client1-frame').src = 'shop1.html?' + Date.now();
            log('üîÑ Client 1 display refreshed');
        }

        function refreshClient2() {
            document.getElementById('client2-frame').src = 'shop2.html?' + Date.now();
            log('üîÑ Client 2 display refreshed');
        }

        function refreshAllDisplays() {
            refreshMaster();
            refreshClient1();
            refreshClient2();
            log('üîÑ All displays refreshed');
        }

        function clearLogs() {
            consoleOutput.innerHTML = 'Console cleared.<br>';
        }

        // Auto-monitoring
        window.addEventListener('load', function() {
            log('üìä Analytics sync test page loaded');
            
            setTimeout(() => {
                updateAnalyticsMetrics();
                testInterval = setInterval(updateAnalyticsMetrics, 2000);
                log('üìä Started automatic analytics monitoring (2s intervals)');
            }, 3000);
        });

        window.addEventListener('beforeunload', function() {
            if (testInterval) {
                clearInterval(testInterval);
            }
        });
    </script>
</body>
</html>
